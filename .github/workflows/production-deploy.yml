name: Stage 3 - Production Deployment

on:
  push:
    branches:
      - main # âœ… Trigger only when PR is merged into main

jobs:
  production-deployment:
    runs-on: ubuntu-latest

    env:
      RESOURCE_GROUP: teddysit722Week10
      AKS_NAME: aksteddy722Week10
      ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
      IMAGE_TAG: ${{ github.sha }} # âœ… Deploy the exact commit
      PROD_NAMESPACE: production

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Connect to AKS
        run: |
          az aks get-credentials --resource-group $RESOURCE_GROUP --name $AKS_NAME
          kubectl cluster-info

      - name: Ensure Production Namespace
        run: |
          kubectl create namespace $PROD_NAMESPACE || echo "Namespace exists"

      - name: Deploy Backend Services
        run: |
          for service in customer_service order_service product_service; do
            K8S_NAME=$(echo $service | sed 's/_/-/g')
            echo "ðŸ“¦ Deploying $service as $K8S_NAME"

            # Replace registry + tag dynamically
            sed "s|sit722teddy.azurecr.io|$ACR_LOGIN_SERVER|g; s|:latest|:$IMAGE_TAG|g" k8s/${service}.yaml \
              | kubectl apply -n $PROD_NAMESPACE -f -

            # Wait for rollout
            kubectl rollout status deployment/$K8S_NAME -n $PROD_NAMESPACE --timeout=300s
            echo "âœ… $service deployed"
          done

      - name: Deploy Frontend
        run: |
          echo "ðŸ“¦ Deploying frontend"
          sed "s|sit722teddy.azurecr.io|$ACR_LOGIN_SERVER|g; s|:latest|:$IMAGE_TAG|g" k8s/frontend.yaml \
            | kubectl apply -n $PROD_NAMESPACE -f -

          kubectl rollout status deployment/frontend -n $PROD_NAMESPACE --timeout=300s
          echo "âœ… Frontend deployed"
