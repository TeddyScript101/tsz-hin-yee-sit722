name: Stage 2 - Staging Deployment

on:
  workflow_run:
    workflows: ["CI Pipeline - Testing Branch"]
    types: [completed]
    branches:
      - testing

jobs:
  staging-deployment:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Connect to AKS
        run: |
          az aks get-credentials \
            --resource-group teddysit722Week10 \
            --name aksteddy722Week10

      - name: Set Namespace
        id: set-namespace
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "namespace=production" >> $GITHUB_OUTPUT
          else
            echo "namespace=staging-${{ github.run_id }}" >> $GITHUB_OUTPUT
          fi

      - name: Create Namespace
        run: |
          kubectl create namespace ${{ steps.set-namespace.outputs.namespace }} || echo "Namespace already exists"

      - name: Deploy Backend Services
        run: |
          for service in customer_service order_service product_service; do
            echo "Deploying $service..."
            kubectl apply -f k8s/${service}/ -n ${{ steps.set-namespace.outputs.namespace }}
            kubectl set image deployment/${service} \
              ${service}=${{ secrets.ACR_LOGIN_SERVER }}/${service}:${{ github.sha }} \
              -n ${{ steps.set-namespace.outputs.namespace }}
          done

      - name: Deploy Frontend
        run: |
          kubectl apply -f k8s/frontend/ -n ${{ steps.set-namespace.outputs.namespace }}
          kubectl set image deployment/frontend \
            frontend=${{ secrets.ACR_LOGIN_SERVER }}/frontend:${{ github.sha }} \
            -n ${{ steps.set-namespace.outputs.namespace }}

      - name: Wait for All Deployments
        run: |
          for service in customer_service order_service product_service frontend; do
            kubectl rollout status deployment/${service} -n ${{ steps.set-namespace.outputs.namespace }} --timeout=300s
          done

      - name: Run Acceptance Tests
        run: |
          echo "Running acceptance tests in namespace ${{ steps.set-namespace.outputs.namespace }}..."

      - name: Cleanup Staging Environment
        if: always() && github.ref != 'refs/heads/main'
        run: |
          kubectl delete namespace ${{ steps.set-namespace.outputs.namespace }} --ignore-not-found=true
